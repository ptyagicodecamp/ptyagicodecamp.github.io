
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://ptyagicodecamp.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://ptyagicodecamp.github.io/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://ptyagicodecamp.github.io/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://ptyagicodecamp.github.io/static/custom.css" rel="stylesheet">

    <link href="https://ptyagicodecamp.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="techLog Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-133714063-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->
    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="ptyagi" />
<meta name="description" content="Persisting theme setting in LocalDatabase using Moor plugin" />
<meta name="keywords" content="Caching, LocalDatabase, Moor, Cross-platform, Flutter, Code-recipes, Android, Android Studio, iOS, development">

<meta property="og:site_name" content="techLog"/>
<meta property="og:title" content="Persisting theme in LocalDatabase (Moor plugin)"/>
<meta property="og:description" content="Persisting theme setting in LocalDatabase using Moor plugin"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://ptyagicodecamp.github.io/persisting-theme-in-localdatabase-moor-plugin.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-12-31 00:00:00-05:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://ptyagicodecamp.github.io/author/ptyagi.html">
<meta property="article:section" content="Flutter"/>
<meta property="article:tag" content="Caching"/>
<meta property="article:tag" content="LocalDatabase"/>
<meta property="article:tag" content="Moor"/>
<meta property="article:tag" content="Cross-platform"/>
<meta property="article:tag" content="Flutter"/>
<meta property="article:tag" content="Code-recipes"/>
<meta property="article:tag" content="Android"/>
<meta property="article:tag" content="Android Studio"/>
<meta property="article:tag" content="iOS"/>
<meta property="article:tag" content="development"/>
<meta property="og:image" content="https://ptyagicodecamp.github.io/images/profile.jpg">

  <title>techLog &ndash; Persisting theme in LocalDatabase (Moor plugin)</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6359982310050489",
      enable_page_level_ads: true
    });
  </script>
</head>
<body>
  <aside>
    <div>
      <a href="https://ptyagicodecamp.github.io">
        <img src="https://ptyagicodecamp.github.io/images/profile.jpg" alt="techLog" title="techLog">
      </a>
      <h1><a href="https://ptyagicodecamp.github.io">techLog</a></h1>

<p>Explore | Android | Flutter | Software Engineering</p>
      <nav>
        <ul class="list">

          <li><a href="https://www.paypal.me/pritya" target="_blank">Support</a></li>
          <li><a href="https://www.codementor.io/ptyagicodecamp" target="_blank">Codementor</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/priyankatyagi" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/ptyagicodecamp" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-medium" href="https://medium.com/@ptyagicodecamp" target="_blank"><i class="fa fa-medium"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/ptyagi13" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-youtube" href="https://www.youtube.com/channel/UCO3_dbHasEnA2dr_U0EhMAA?view_as=subscriber" target="_blank"><i class="fa fa-youtube"></i></a></li>
        <li><a class="sc-codementor" href="https://www.codementor.io/ptyagicodecamp" target="_blank"><i class="fa fa-codementor"></i></a></li>
      </ul>
    </div>

      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <ins class="adsbygoogle ads-aside"
           data-ad-client="ca-pub-6359982310050489"
           data-ad-slot="8977779775"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>

  </aside>
  <main>

    <nav>
      <a href="https://ptyagicodecamp.github.io">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://ptyagicodecamp.github.io/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="persisting-theme-in-localdatabase-moor-plugin">Persisting theme in LocalDatabase (Moor plugin)</h1>
    <p>
          Posted on December 31, 2019 in <a href="https://ptyagicodecamp.github.io/category/flutter.html">Flutter</a>


    </p>
  </header>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-6359982310050489"
         data-ad-slot="6546879945"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

  <div>
    <p><img alt="x-platform-themes" src="https://ptyagicodecamp.github.io/themes_moor.png"></p>
<h3>Background</h3>
<p>In <a href="https://ptyagicodecamp.github.io/implement-flutter-themes-using-provider.html">this previous article</a>, we saw how to implement theme switching using Provider. In this article, we'll see how to save the selected theme in app's local database to persist the last selected theme across app restarts.</p>
<hr>
<p><strong>Checkout related articles:</strong></p>
<ul>
<li>
<p><a href="https://ptyagicodecamp.github.io/implement-flutter-themes-using-provider.html">Implement Flutter themes using Provider</a></p>
</li>
<li>
<p><a href="https://ptyagicodecamp.github.io/persisting-theme-using-sharedpreferences-android-ios-and-web.html">Persisting theme using SharedPreferences (Android, iOS, and Web)</a></p>
</li>
</ul>
<hr>
<p><strong>Target Audience:</strong> Beginner</p>
<p><strong>Recipe:</strong> Persist selected theme in FlutterApp's local database using <a href="https://pub.dev/packages/moor">Moor plugin</a>.</p>
<p><strong>Focus Widget:</strong> <a href="https://pub.dev/packages/moor">Moor plugin</a></p>
<p><strong>Goal:</strong> Persisting chosen theme in local database. Implement a simple UI with an image, text and a button to switch themes. Page's default theme is light. Clicking on "Switch Theme" button will apply dark theme to page, and vice versa. Switching theme will save selected theme in app's local database using <a href="https://pub.dev/packages/moor">Moor plugin</a>.</p>
<p><strong>Light Theme:</strong></p>
<p><img alt="light-theme" src="https://ptyagicodecamp.github.io/ios_themes2.jpg"></p>
<p><strong>Dark Theme:</strong></p>
<p><img alt="dark-theme" src="https://ptyagicodecamp.github.io/ios_themes3.jpg"></p>
<hr>
<p><strong>Checkout the companion video tutorial:</strong>
<iframe width="560" height="315" src="https://www.youtube.com/embed/hEZ0_jSIuUU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>
<hr>
<p><strong>Note:</strong> In this article, I'll only focus on persisting data in database. Please refer to <a href="https://ptyagicodecamp.github.io/implement-flutter-themes-using-provider.html">previous article</a> for app architecture and other details.</p>
<h3>Step #1. <code>pubspec.yaml</code></h3>
<p>Add package dependencies in <code>pubspec.yaml</code>:</p>
<div class="highlight"><pre><span></span><span class="n">dependencies</span><span class="o">:</span>
  <span class="n">flutter</span><span class="o">:</span>
    <span class="n">sdk</span><span class="o">:</span> <span class="n">flutter</span>

  <span class="n">moor</span><span class="o">:</span> <span class="o">^</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span>

  <span class="err">#</span> <span class="n">Dart</span> <span class="n">bindings</span> <span class="n">to</span> <span class="n">sqlite</span>
  <span class="n">moor_ffi</span><span class="o">:</span> <span class="o">^</span><span class="mf">0.2</span><span class="o">.</span><span class="mi">0</span>

  <span class="err">#</span> <span class="n">Helper</span> <span class="n">to</span> <span class="n">find</span> <span class="n">the</span> <span class="n">database</span> <span class="n">path</span> <span class="n">on</span> <span class="n">mobile</span>
  <span class="n">path_provider</span><span class="o">:</span> <span class="o">^</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">1</span>
  <span class="n">path</span><span class="o">:</span> <span class="o">^</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">4</span>

  <span class="n">dev_dependencies</span><span class="o">:</span>
    <span class="n">flutter_test</span><span class="o">:</span>
      <span class="n">sdk</span><span class="o">:</span> <span class="n">flutter</span>

    <span class="err">#</span><span class="n">This</span> <span class="n">generator</span> <span class="n">library</span> <span class="n">turns</span> <span class="n">Table</span> <span class="n">classes</span> <span class="n">from</span> <span class="n">moor</span> <span class="n">into</span> <span class="n">database</span> <span class="n">code</span><span class="o">.</span>
    <span class="n">moor_generator</span><span class="o">:</span> <span class="o">^</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span>

    <span class="err">#</span><span class="n">generates</span> <span class="n">files</span> <span class="n">using</span> <span class="n">Dart</span> <span class="n">code</span><span class="o">.</span>  
    <span class="n">build_runner</span><span class="o">:</span> <span class="o">^</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">0</span>
</pre></div>


<ul>
<li>
<p><a href="https://pub.dev/packages/moor"><code>moor</code> plugin</a> : Persistence library built on top of sqlite for Dart and Flutter. It works on Android, iOS and Web platforms for persisting data in local databases.</p>
</li>
<li>
<p><a href="https://pub.dev/packages/moor_ffi"><code>moor_ffi</code> plugin</a> : This Flutter plugin generates Dart bindings to sqlite by using <a href="https://api.dart.dev/stable/2.7.0/dart-ffi/dart-ffi-library.html"><code>dart:ffi</code></a>. <code>ffi</code> stands for <code>Foreign Function Interface</code>. This plugin can be used with Flutter and/or Dart VM applications and supports all platforms where sqlite3 is installed: iOS, Android (Flutter), macOS, Linux and Windows.</p>
</li>
<li>
<p><a href="https://pub.dev/packages/path_provider"><code>path_provider</code> plugin</a> : This Flutter plugin is used for accessing filesystem on Android and iOS platforms.</p>
</li>
<li>
<p><a href="https://pub.dev/packages/path"><code>path</code> plugin</a> : A cross-platform filesystem path manipulation library for Dart.</p>
</li>
<li>
<p><a href="https://pub.dev/packages/moor_generator"><code>moor_generator</code> plugin</a> : This library contains the generator that turns your Table classes from moor into database code.</p>
</li>
<li>
<p><a href="https://pub.dev/packages/build_runner"><code>build_runner</code> plugin</a> : This package is used to generate files. We need this package to be able to run this command <code>flutter packages pub run build_runner build --delete-conflicting-outputs</code> to generate <code>*.g.dart</code> files.</p>
</li>
</ul>
<h3>Step #2.  Using Moor to prepare Database</h3>
<p>First, we'll use Moor to prepare Database to save <code>theme_id</code> and <code>theme_name</code>. Selected theme's id will be saved. This table will have only one entry at a given time. When theme switched from <code>light</code> to <code>dark</code>, the older entry will be deleted, and newly selected theme's id will be added to this table. I kept it simple on purpose to demonstrate how moor can be integrated in your app.</p>
<p>Let's take look at our database file : <code>themes_pref.dart</code> below.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="s1">&#39;package:flutter_widgets/themes/db/themes_notifier_db.dart&#39;</span><span class="p">;</span>
<span class="kn">import</span> <span class="s1">&#39;package:moor/moor.dart&#39;</span><span class="p">;</span>

<span class="n">part</span> <span class="s1">&#39;theme_prefs.g.dart&#39;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">this</span> <span class="n">will</span> <span class="n">generate</span> <span class="n">a</span> <span class="n">table</span> <span class="n">called</span> <span class="s2">&quot;theme_prefs&quot;</span> <span class="k">for</span> <span class="n">us</span><span class="o">.</span> <span class="n">The</span> <span class="n">rows</span> <span class="n">of</span> <span class="n">that</span> <span class="n">table</span> <span class="n">will</span>
<span class="o">//</span> <span class="n">be</span> <span class="n">represented</span> <span class="n">by</span> <span class="n">a</span> <span class="k">class</span> <span class="nc">called</span> <span class="s2">&quot;ThemePref&quot;</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">ThemePrefs</span> <span class="n">extends</span> <span class="n">Table</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">MyThemes</span> <span class="nb">id</span>
  <span class="n">IntColumn</span> <span class="n">get</span> <span class="n">theme_id</span> <span class="o">=&gt;</span> <span class="n">integer</span><span class="p">()();</span>
  <span class="n">TextColumn</span> <span class="n">get</span> <span class="n">theme_name</span> <span class="o">=&gt;</span> <span class="n">text</span><span class="p">()();</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Moor</span> <span class="n">prepares</span> <span class="n">database</span> <span class="n">table</span>
<span class="nd">@UseMoor</span><span class="p">(</span><span class="n">tables</span><span class="p">:</span> <span class="p">[</span><span class="n">ThemePrefs</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">MyDatabase</span> <span class="n">extends</span> <span class="n">_</span><span class="err">$</span><span class="n">MyDatabase</span> <span class="p">{</span>
  <span class="n">MyDatabase</span><span class="p">(</span><span class="n">QueryExecutor</span> <span class="n">e</span><span class="p">)</span> <span class="p">:</span> <span class="nb">super</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">Bump</span> <span class="n">schemaVersion</span> <span class="n">whenever</span> <span class="n">there</span><span class="s1">&#39;s change.</span>
  <span class="nd">@override</span>
  <span class="nb">int</span> <span class="n">get</span> <span class="n">schemaVersion</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">;</span>

  <span class="o">//</span><span class="n">Keeping</span> <span class="n">it</span> <span class="n">simple</span>
  <span class="o">//</span><span class="n">reset</span> <span class="n">the</span> <span class="n">database</span> <span class="n">whenever</span> <span class="n">there</span><span class="s1">&#39;s update.</span>
  <span class="o">//</span> <span class="n">Add</span> <span class="n">light</span> <span class="n">theme</span> <span class="k">as</span> <span class="n">default</span> <span class="n">theme</span> <span class="n">after</span> <span class="n">first</span> <span class="n">launch</span> <span class="ow">and</span> <span class="n">upgrade</span>
  <span class="nd">@override</span>
  <span class="n">MigrationStrategy</span> <span class="n">get</span> <span class="n">migration</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">MigrationStrategy</span><span class="p">(</span><span class="n">onCreate</span><span class="p">:</span> <span class="p">(</span><span class="n">Migrator</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">createAllTables</span><span class="p">();</span>
    <span class="p">},</span> <span class="n">onUpgrade</span><span class="p">:</span> <span class="p">(</span><span class="n">Migrator</span> <span class="n">m</span><span class="p">,</span> <span class="nb">int</span> <span class="n">from</span><span class="p">,</span> <span class="nb">int</span> <span class="n">to</span><span class="p">)</span> <span class="n">async</span> <span class="p">{</span>
      <span class="n">m</span><span class="o">.</span><span class="n">deleteTable</span><span class="p">(</span><span class="n">themePrefs</span><span class="o">.</span><span class="n">actualTableName</span><span class="p">);</span>
      <span class="n">m</span><span class="o">.</span><span class="n">createAllTables</span><span class="p">();</span>
    <span class="p">},</span> <span class="n">beforeOpen</span><span class="p">:</span> <span class="p">(</span><span class="n">details</span><span class="p">)</span> <span class="n">async</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">wasCreated</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">await</span> <span class="n">into</span><span class="p">(</span><span class="n">themePrefs</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ThemePrefsCompanion</span><span class="p">(</span>
          <span class="n">theme_id</span><span class="p">:</span> <span class="n">const</span> <span class="n">Value</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
          <span class="n">theme_name</span><span class="p">:</span> <span class="n">Value</span><span class="p">(</span><span class="n">MyThemes</span><span class="o">.</span><span class="n">light</span><span class="o">.</span><span class="n">toString</span><span class="p">()),</span>
        <span class="p">));</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="n">void</span> <span class="n">activateTheme</span><span class="p">(</span><span class="n">MyThemes</span> <span class="n">theme</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ThemePref</span> <span class="n">pref</span> <span class="o">=</span>
        <span class="n">ThemePref</span><span class="p">(</span><span class="n">theme_id</span><span class="p">:</span> <span class="n">theme</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">theme_name</span><span class="p">:</span> <span class="n">theme</span><span class="o">.</span><span class="n">toString</span><span class="p">());</span>
    <span class="n">into</span><span class="p">(</span><span class="n">themePrefs</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pref</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">void</span> <span class="n">deactivateTheme</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">themePrefs</span><span class="p">)</span><span class="o">..</span><span class="n">where</span><span class="p">((</span><span class="n">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">theme_id</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="o">.</span><span class="n">go</span><span class="p">();</span>

  <span class="o">//</span><span class="n">The</span> <span class="n">stream</span> <span class="n">will</span> <span class="n">automatically</span> <span class="n">emit</span> <span class="n">new</span> <span class="n">items</span> <span class="n">whenever</span> <span class="n">the</span> <span class="n">underlying</span> <span class="n">data</span> <span class="n">changes</span><span class="o">.</span>
  <span class="n">Stream</span><span class="o">&lt;</span><span class="nb">bool</span><span class="o">&gt;</span> <span class="n">themeIdExists</span><span class="p">(</span><span class="nb">int</span> <span class="nb">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">select</span><span class="p">(</span><span class="n">themePrefs</span><span class="p">)</span>
        <span class="o">.</span><span class="n">watch</span><span class="p">()</span>
        <span class="o">.</span><span class="n">map</span><span class="p">((</span><span class="n">prefs</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">prefs</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">pref</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">pref</span><span class="o">.</span><span class="n">theme_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="n">Future</span><span class="o">&lt;</span><span class="n">ThemePref</span><span class="o">&gt;</span> <span class="n">getActiveTheme</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">select</span><span class="p">(</span><span class="n">themePrefs</span><span class="p">)</span><span class="o">.</span><span class="n">getSingle</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Please note that this line will show error in the beginning because this file doesn't exist yet: <code>part 'theme_prefs.g.dart';</code>. You'll need to execute following command to generate sqlite bindings:</p>
<div class="highlight"><pre><span></span>  flutter packages pub run build_runner build --delete-conflicting-outputs
</pre></div>


<p><code>ThemePrefs</code> table contains only two fields: <code>theme_id</code> to save id for the theme and another field for saving name.</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">ThemePrefs</span> <span class="kr">extends</span> <span class="nx">Table</span> <span class="p">{</span>
  <span class="c1">// MyThemes id</span>
  <span class="nx">IntColumn</span> <span class="nx">get</span> <span class="nx">theme_id</span> <span class="o">=&gt;</span> <span class="nx">integer</span><span class="p">()();</span>
  <span class="nx">TextColumn</span> <span class="nx">get</span> <span class="nx">theme_name</span> <span class="o">=&gt;</span> <span class="nx">text</span><span class="p">()();</span>
<span class="p">}</span>
</pre></div>


<p>Following part actually prepares database table. This is the class where migration strategy is described. I kept migration strategy simple in this recipe. It resets the tables, and make <code>light</code> theme default in case of first launch or upgrade.</p>
<div class="highlight"><pre><span></span><span class="kd">@UseMoor</span><span class="p">(</span><span class="nx">tables</span><span class="o">:</span> <span class="p">[</span><span class="nx">ThemePrefs</span><span class="p">])</span>
<span class="kr">class</span> <span class="nx">MyDatabase</span> <span class="kr">extends</span> <span class="nx">_$MyDatabase</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div>


<h3>Step #3. Sharing Database implementation across platforms</h3>
<p>We'll be creating one file to write shared code, and two files for native and web implementation for accessing database on corresponding platforms.</p>
<p><strong>Shared:</strong> <code>shared.dart</code></p>
<div class="highlight"><pre><span></span>export &#39;unsupported.dart&#39;
    if (dart.library.html) &#39;web.dart&#39;
    if (dart.library.io) &#39;mobile.dart&#39;;
</pre></div>


<p><strong>Native (Android / iOS):</strong> <code>mobile.dart</code></p>
<div class="highlight"><pre><span></span><span class="o">//</span><span class="nt">Note</span><span class="o">:</span> <span class="nt">Implementation</span> <span class="nt">borrowed</span> <span class="nt">from</span> <span class="nt">this</span> <span class="nt">To</span> <span class="nt">Do</span> <span class="nt">App</span> <span class="nt">Template</span> <span class="nt">project</span>
<span class="o">//</span><span class="nt">https</span><span class="o">://</span><span class="nt">github</span><span class="p">.</span><span class="nc">com</span><span class="o">/</span><span class="nt">appleeducate</span><span class="o">/</span><span class="nt">moor_shared</span>
<span class="nt">MyDatabase</span> <span class="nt">constructDb</span><span class="o">(</span><span class="p">{</span><span class="err">bool</span> <span class="err">logStatements</span> <span class="err">=</span> <span class="err">false</span><span class="p">}</span><span class="o">)</span> <span class="p">{</span>
  <span class="err">if</span> <span class="err">(Platform.isIOS</span> <span class="err">||</span> <span class="err">Platform.isAndroid)</span> <span class="err">{</span>
    <span class="err">final</span> <span class="err">executor</span> <span class="err">=</span> <span class="err">LazyDatabase(()</span> <span class="err">async</span> <span class="err">{</span>
      <span class="err">final</span> <span class="err">dataDir</span> <span class="err">=</span> <span class="err">await</span> <span class="err">paths.getApplicationDocumentsDirectory()</span><span class="p">;</span>
      <span class="err">final</span> <span class="err">dbFile</span> <span class="err">=</span> <span class="err">File(p.join(dataDir.path,</span> <span class="err">&#39;db.sqlite&#39;))</span><span class="p">;</span>
      <span class="err">return</span> <span class="err">VmDatabase(dbFile,</span> <span class="n">logStatements</span><span class="p">:</span> <span class="n">logStatements</span><span class="p">);</span>
    <span class="p">}</span><span class="o">);</span>
    <span class="nt">return</span> <span class="nt">MyDatabase</span><span class="o">(</span><span class="nt">executor</span><span class="o">);</span>
  <span class="err">}</span>
  <span class="nt">if</span> <span class="o">(</span><span class="nt">Platform</span><span class="p">.</span><span class="nc">isMacOS</span> <span class="o">||</span> <span class="nt">Platform</span><span class="p">.</span><span class="nc">isLinux</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">final</span> <span class="err">file</span> <span class="err">=</span> <span class="err">File(&#39;db.sqlite&#39;)</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">MyDatabase(VmDatabase(file,</span> <span class="n">logStatements</span><span class="p">:</span> <span class="n">logStatements</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="nt">if</span> <span class="o">(</span><span class="nt">Platform</span><span class="p">.</span><span class="nc">isWindows</span><span class="o">)</span> <span class="p">{</span>
    <span class="err">final</span> <span class="err">file</span> <span class="err">=</span> <span class="err">File(&#39;db.sqlite&#39;)</span><span class="p">;</span>
    <span class="err">return</span> <span class="err">MyDatabase(VmDatabase(file,</span> <span class="n">logStatements</span><span class="p">:</span> <span class="n">logStatements</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="nt">return</span> <span class="nt">MyDatabase</span><span class="o">(</span><span class="nt">VmDatabase</span><span class="p">.</span><span class="nc">memory</span><span class="o">(</span><span class="nt">logStatements</span><span class="o">:</span> <span class="nt">logStatements</span><span class="o">));</span>
<span class="err">}</span>
</pre></div>


<p><strong>Web:</strong> <code>web.dart</code></p>
<div class="highlight"><pre><span></span><span class="nt">MyDatabase</span> <span class="nt">constructDb</span><span class="o">(</span><span class="p">{</span><span class="err">bool</span> <span class="err">logStatements</span> <span class="err">=</span> <span class="err">false</span><span class="p">}</span><span class="o">)</span> <span class="p">{</span>
  <span class="err">return</span> <span class="err">MyDatabase(WebDatabase(&#39;db&#39;,</span> <span class="n">logStatements</span><span class="p">:</span> <span class="n">logStatements</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>


<p>Checkout <a href="https://moor.simonbinder.eu/web/">this link</a> to configure Moor for FlutterWeb.</p>
<p><strong>Unsupported platform:</strong> <code>unsupported.dart</code></p>
<div class="highlight"><pre><span></span>MyDatabase constructDb({bool logStatements = false}) {
  throw &#39;Platform not supported&#39;;
}
</pre></div>


<p>Checkout db plugin <a href="https://github.com/ptyagicodecamp/flutter_cookbook/tree/widgets/flutter_widgets/lib/plugins/db">source code here</a>.</p>
<h3>Step #4. App's entry point</h3>
<p>This code recipe is a part of the <a href="https://ptyagicodecamp.github.io/flutter-live-booklet-flutter-component-recipes.html#flutter-live-booklet-flutter-component-recipes">code recipes</a> app as shown below:</p>
<p><img alt="x-cookbook-flutter" src="https://ptyagicodecamp.github.io/cookbook_menu.jpg"></p>
<hr>
<p>There are two ways to run this code recipe:</p>
<ol>
<li>StandAlone: Use following code snippet at the top of the <a href="https://github.com/ptyagicodecamp/flutter_cookbook/blob/widgets/flutter_widgets/lib/themes/db/themes_db.dart">themes_db.dart</a> to run it independently.</li>
</ol>
<div class="highlight"><pre><span></span>void main() =&gt; runApp(MultiProvider(
      providers: [
        Provider&lt;MyDatabase&gt;(
          builder: (_) =&gt; constructDb(logStatements: true),
          dispose: (context, db) =&gt; db.close(),
        ),
        ChangeNotifierProvider&lt;ThemesNotifierDB&gt;(
          builder: (_) {
            return ThemesNotifierDB();
          },
        )
      ],
      child: ThemesDBCaching(),
    ));
</pre></div>


<ol>
<li>Code Recipe App: Use following code in <a href="https://github.com/ptyagicodecamp/flutter_cookbook/blob/widgets/flutter_widgets/lib/router.dart"><code>router.dart</code></a> to run this code recipe as part of the code recipe app.</li>
</ol>
<div class="highlight"><pre><span></span>case THEMES_DEMO_DB:
  return MaterialPageRoute(builder: (context) {
    return MultiProvider(
      providers: [
        Provider&lt;MyDatabase&gt;(
          builder: (_) =&gt; constructDb(logStatements: true),
          dispose: (context, db) =&gt; db.close(),
        ),
        ChangeNotifierProvider&lt;ThemesNotifierDB&gt;(
          builder: (_) {
            return ThemesNotifierDB();
          },
        )
      ],
      child: ThemesDBCaching(),
    );
  });
  break;
</pre></div>


<h3>Step #5. Loading theme from database</h3>
<p>Stateful widget <code>ThemesDBCaching</code> loads active theme using <code>Provider.of&lt;ThemesNotifierDB&gt;(context).loadActiveThemeData(context);</code></p>
<p><strong>themes_db.dart:</strong></p>
<p>Here's code snippet:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">_ThemesDBCachingState</span> <span class="kr">extends</span> <span class="nx">State</span><span class="o">&lt;</span><span class="nx">ThemesDBCaching</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kd">@override</span>
  <span class="nx">Widget</span> <span class="nx">build</span><span class="p">(</span><span class="nx">BuildContext</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">Provider</span><span class="p">.</span><span class="nx">of</span><span class="o">&lt;</span><span class="nx">ThemesNotifierDB</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">loadActiveThemeData</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">MaterialApp</span><span class="p">(</span>
        <span class="nx">theme</span>: <span class="kt">Provider.of</span><span class="o">&lt;</span><span class="nx">ThemesNotifierDB</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">context</span><span class="p">).</span><span class="nx">currentThemeData</span><span class="p">,</span>
        <span class="nx">home</span>: <span class="kt">Scaffold</span><span class="p">(</span>
          <span class="nx">appBar</span>: <span class="kt">AppBar</span><span class="p">(</span>
            <span class="nx">title</span>: <span class="kt">Text</span><span class="p">(</span><span class="s2">&quot;Theme DB Caching (Moor)&quot;</span><span class="p">),</span>
          <span class="p">),</span>
          <span class="nx">body</span>: <span class="kt">body</span><span class="p">(),</span>
        <span class="p">));</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>  
</pre></div>


<p><strong>themes_notifier_db.dart:</strong></p>
<p>Fetching <code>theme_id</code> from database, loading and notifying currentTheme:</p>
<div class="highlight"><pre><span></span>//fetch theme_id from database
Future&lt;int&gt; getActiveThemeID(BuildContext context) {
  return Provider.of&lt;MyDatabase&gt;(context)
      .getActiveTheme()
      .then((themePref) =&gt; themePref.theme_id);
}

//Load active theme using theme_id
void loadActiveThemeData(BuildContext context) async {
  int themeId = await getActiveThemeID(context);
  currentTheme = MyThemes.values[themeId];
}

//notify to listeners about the updated theme
set currentTheme(MyThemes theme) {
  if (theme != null) {
    _currentTheme = theme;
    _currentThemeData = themeData[_currentTheme.index];
    notifyListeners();
  }
}
</pre></div>


<h3>Step #6: Switching and Saving theme to database</h3>
<p>Switching theme toggles previously selected theme. <code>oldTheme</code> is removed from the database using <code>deactivateTheme(...)</code>. Newly updated <code>currentTheme</code> is added to database using <code>activateTheme(...)</code>.</p>
<div class="highlight"><pre><span></span>void switchTheme(BuildContext context) async {
  var oldTheme = currentTheme;

  currentTheme == MyThemes.light
      ? currentTheme = MyThemes.dark
      : currentTheme = MyThemes.light;

  var myDatabase = Provider.of&lt;MyDatabase&gt;(context);
  var isOldThemeActive = myDatabase.themeIdExists(oldTheme.index);

  if (isOldThemeActive != null) {
    myDatabase.deactivateTheme(oldTheme.index);
  }

  myDatabase.activateTheme(currentTheme);
}
</pre></div>


<p>All Done !</p>
<h3>Source Code</h3>
<ol>
<li>
<p>Recipe source code is available <a href="https://github.com/ptyagicodecamp/flutter_cookbook/tree/widgets/flutter_widgets/lib/themes/db">here</a></p>
</li>
<li>
<p>Code recipe project's source code is available <a href="https://github.com/ptyagicodecamp/flutter_cookbook/tree/widgets/flutter_widgets/">here</a></p>
</li>
</ol>
<h3>References:</h3>
<ol>
<li><a href="https://pub.dev/packages/moor"><code>moor</code> plugin</a></li>
<li><a href="https://pub.dev/packages/moor_ffi"><code>moor_ffi</code> plugin</a></li>
<li><a href="https://pub.dev/packages/path_provider"><code>path_provider</code> plugin</a></li>
<li><a href="https://pub.dev/packages/path"><code>path</code> plugin</a></li>
<li><a href="https://pub.dev/packages/moor_generator"><code>moor_generator</code> plugin</a></li>
<li><a href="https://pub.dev/packages/build_runner"><code>build_runner</code> plugin</a></li>
<li><a href="https://github.com/appleeducate/moor_shared">Cross-platform ToDo App template</a></li>
<li><a href="https://ptyagicodecamp.github.io/implement-flutter-themes-using-provider.html">Previous article: Implement Flutter themes using Provider</a></li>
<li><a href="https://ptyagicodecamp.github.io/persisting-theme-using-sharedpreferences-android-ios-and-web.html">Related article: Persisting theme using SharedPreferences (Android, iOS, and Web)</a></li>
</ol>
<p>Happy cooking with Flutter :)</p>
<p><em>Liked the article ?
Couldn't find a topic of your interest ? Please leave comments or <a href="mailto:ptyagicodecamp@gmail.com">email me</a> about topics you would like me to write !
<a href="https://www.paypal.me/pritya">BTW I love cupcakes and coffee both :)</a></em></p>
<p>Follow me at <a href="https://twitter.com/ptyagi13">twitter</a></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://ptyagicodecamp.github.io/tag/caching.html">Caching</a>
      <a href="https://ptyagicodecamp.github.io/tag/localdatabase.html">LocalDatabase</a>
      <a href="https://ptyagicodecamp.github.io/tag/moor.html">Moor</a>
      <a href="https://ptyagicodecamp.github.io/tag/cross-platform.html">Cross-platform</a>
      <a href="https://ptyagicodecamp.github.io/tag/flutter.html">Flutter</a>
      <a href="https://ptyagicodecamp.github.io/tag/code-recipes.html">Code-recipes</a>
      <a href="https://ptyagicodecamp.github.io/tag/android.html">Android</a>
      <a href="https://ptyagicodecamp.github.io/tag/android-studio.html">Android Studio</a>
      <a href="https://ptyagicodecamp.github.io/tag/ios.html">iOS</a>
      <a href="https://ptyagicodecamp.github.io/tag/development.html">development</a>
    </p>
  </div>

  <div class="center social-share">
    <p>    Like this article? Share it with your friends!
</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
    <div class="addthis_inline_share_toolbox"></div>
  </div>


    <div class="addthis_relatedposts_inline"></div>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle ads-responsive"
         data-ad-client="ca-pub-6359982310050489"
         data-ad-slot="6546879945"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'https-ptyagicodecamp-github-io';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>
  &copy;  2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>


    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cf387135c8761da" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " techLog ",
  "url" : "https://ptyagicodecamp.github.io",
  "image": "https://ptyagicodecamp.github.io/images/profile.jpg",
  "description": "Mobile engineering tech logger."
}
</script>

<a href="https://github.com/ptyagicodecamp" class="github-corner" aria-label="View source on Github">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></body>
</html>